import{r as p,e as H,j as e,n as N,b as B,s as O}from"./index-BXj9KiiF.js";import{H as F}from"./Header-Dl4dmuQR.js";import{B as I}from"./Button-CV-dwmT3.js";import{a as q,i as P,M as _,T as D,l as J,b as K,c as Q,g as U}from"./progression-BHCe-Ar1.js";import{r as M}from"./time-WGOIUK2d.js";import{C as V}from"./catalog-BEuPirhP.js";function X(s){const o=Math.max(0,Math.floor(s/1e3)),g=Math.floor(o/60).toString().padStart(2,"0"),n=(o%60).toString().padStart(2,"0");return"".concat(g,":").concat(n)}function at({player:s,onBack:o,onUpdatePlayer:g}){const[n,f]=p.useState(()=>q()),u=P(n),C=n?M(n.endsAt):0,d=p.useMemo(()=>{const t=H(s);return t.str+t.agi+t.int+t.vit+s.progress.level*2},[s]);p.useEffect(()=>{const t=setInterval(()=>f(q()),1e3);return()=>clearInterval(t)},[]);function T(t){if(u)return;try{if((J().active||[]).length>0){alert("Сначала завершите текущие задания/работы.");return}}catch(i){}const r=K(s,t);f(r)}function E(){var c,y,b;if(!n||M(n.endsAt)>0)return;const t=n.difficulty,r=.5+(d-t)/100,i=Math.max(.05,Math.min(.95,r)),m=Math.random()<i;if(Q(null),f(null),m){const h=s.progress.level,j=d-t,R=Math.max(.7,Math.min(1.5,1+j/120)),w=(c=n.rewardMul)!=null?c:1,S=.9+Math.random()*.2,k=Math.max(5,Math.round((30+h*6)*R*w*S)),A=Math.max(5,Math.round((18+h*3)*R*w*S));let l=U(s,{gold:k,xp:A});const L=Math.max(0,Math.min(30,(y=s.luck)!=null?y:0)),W=Math.max(.08,Math.min(.5,.18+L*.008+Math.max(0,j)*.003));if(Math.random()<W){const v=[{t:1,lvl:1},{t:2,lvl:20},{t:3,lvl:40},{t:4,lvl:60}],$=(b=[...v].reverse().find(a=>h>=a.lvl))!=null?b:v[0],z=s.classId,x=V.filter(a=>a.classReq===z&&/_t\d+$/.test(a.id)&&a.id.endsWith("t".concat($.t)));if(x.length>0){const a=x[Math.floor(Math.random()*x.length)],G={id:a.id,name:a.name,slot:a.slot,rarity:a.rarity,requiredLevel:a.requiredLevel,classReq:a.classReq};l={...l,inventory:[...l.inventory,G]}}}N("quest","Победа над монстром",{gold:k,xp:A});try{B("Победа над монстром! Награда получена.")}catch(v){}O(l),g(l)}else try{B("Поражение. Монстр оказался сильнее.")}catch(h){}}return e.jsxs("div",{style:{display:"grid",gap:12,padding:16},children:[e.jsx(F,{title:"Бой с монстром",gold:s.gold,energy:s.energy,level:s.progress.level,onBack:o}),!u&&e.jsx("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:e.jsx("div",{style:{display:"grid",gap:8},children:e.jsx("div",{style:{display:"grid",gap:8},children:[..._].sort((t,r)=>t.diffMul-r.diffMul).map(t=>{const r=s.progress.level,i=Math.round((40+r*8)*t.diffMul),m=.5+(d-i)/100,c=Math.max(.05,Math.min(.95,m));return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[t.image?e.jsx("img",{src:t.image,alt:t.name,style:{width:40,height:40,objectFit:"cover",borderRadius:8}}):e.jsx("div",{style:{width:40,height:40,borderRadius:8,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:700},children:t.name}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Сложность: ",i," • Шанс победы: ",Math.round(c*100),"% • Награда x",t.rewardMul]})]})]}),e.jsx(I,{onClick:()=>T(t),children:"Сразиться"})]},t.id)})})})}),u&&n&&e.jsx("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:e.jsxs("div",{style:{display:"grid",gap:8},children:[e.jsx("div",{style:{fontWeight:700},children:n.monster}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(D,{endsAt:n.endsAt}),e.jsx("span",{style:{opacity:.85},children:X(C)})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Мощь: ",d," • Сложность: ",n.difficulty]}),e.jsx(I,{disabled:M(n.endsAt)>0,onClick:E,children:"Завершить бой"})]})})]})}export{at as default};
