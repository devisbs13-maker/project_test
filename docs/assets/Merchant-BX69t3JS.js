import{r as M,j as e,s as te,n as se}from"./index-By2cNAY-.js";import{H as ce}from"./Header-CHg887X4.js";import{B as w}from"./Button-B4YQqtbm.js";import{C as T}from"./catalog-z_q2Z5IU.js";import{g as de}from"./index-FU-_DbfN.js";import"./ru-DqIjrUCB.js";const ae="mirevald:economy";function re(t){localStorage.setItem(ae,JSON.stringify(t))}function he(){try{const t=localStorage.getItem(ae);return t?JSON.parse(t):null}catch(t){return null}}const ne=(t,v,d)=>Math.max(v,Math.min(d,t));function $(t,v,d){var j,I,N;const i=(j=d.karma)!=null?j:0,f=(I=d.luck)!=null?I:0,C=(N=d.sociality)!=null?N:0,m=ne(i,-30,30)/30,p=1-m*.12,B=1+m*.08,P=ne(f,0,30)/30,L=1-P*.04,D=1+P*.03,k=1+-Math.min(.08,Math.floor(C/5)*.01),W=p*L*k,E=B*D,a=t==="buy"?W:E,h=1+(Math.random()*.02-.01),R=v*a*h;return Math.max(1,Math.round(R))}function q(t){return t==="common"?1:t==="uncommon"?1.2:t==="rare"?1.6:2.2}function ie(t,v){var i;const d=Math.round(((i=t.sellBase)!=null?i:t.basePrice*.45)*q(t.rarity));return $("sell",d,v)}const ue="v2",le=()=>"".concat(new Date().toISOString().slice(0,10),"-").concat(ue);function oe(t){var S,k,W,E;const v=le(),d=()=>Math.random(),i=(k=(S=t.progress)==null?void 0:S.level)!=null?k:1,f=[{t:1,lvl:1},{t:2,lvl:20},{t:3,lvl:40},{t:4,lvl:60}],C=(W=[...f].reverse().find(a=>i>=a.lvl))!=null?W:f[0],m=T.filter(a=>a.classReq===t.classId&&/_t\d+$/.test(a.id)&&a.id.endsWith("t".concat(C.t))),p=[];for(const a of m){const h=q(a.rarity),R=Math.round(a.basePrice*h),j=$("buy",R,t);p.push({itemId:a.id,qty:1,price:j,rarity:a.rarity})}const B=T.filter(a=>!p.find(h=>h.itemId===a.id)),P=Math.min(30,Math.max(0,(E=t.luck)!=null?E:0)),L=.15+P*.01,D=.04+P*.004;for(;p.length<8&&B.length;){const a=Math.floor(d()*B.length),h=B.splice(a,1)[0];if(h.rarity==="rare"&&d()>L||h.rarity==="epic"&&d()>D)continue;const R=q(h.rarity),j=Math.round(h.basePrice*R),I=$("buy",j,t);p.push({itemId:h.id,qty:1+Math.floor(d()*2),price:I,rarity:h.rarity})}return{dateKey:v,offers:p}}function ye(t){return t.dateKey!==le()}function O(t){return t==="common"?"#9aa3ad":t==="uncommon"?"#3fb950":t==="rare"?"#539bf5":"#a371f7"}function fe({player:t,onBack:v,onUpdatePlayer:d}){var j,I,N,_,A,J,K,H,G,V,Y,Q,X,Z;const i=de(),[f,C]=M.useState("buy"),[m,p]=M.useState("resources"),[B,P]=M.useState("all"),[L,D]=M.useState(()=>{const s=he();if(!s||ye(s)){const n=oe(t);return re(n),n}return s}),S=M.useMemo(()=>new Map(T.map(s=>[s.id,s])),[]);try{const s=L.offers.filter(n=>S.has(n.itemId));if(L.offers.length>0&&s.length===0){const n=oe(t);re(n),D(n)}}catch(s){}function k(s){var l,y,b,x;const n=S.get(s);if(!n)return;const o=Math.round(n.basePrice*q(n.rarity)),r=$("buy",o,t);if(t.gold<r)return;const u={id:n.id,name:n.name,slot:n.slot,rarity:n.rarity,requiredLevel:n.requiredLevel,classReq:n.classReq},c={...t,gold:t.gold-r,inventory:[...t.inventory,u]};te(c),d(c);try{se("quest",(y=(l=i.merchant)==null?void 0:l.purchase)!=null?y:"Purchase",{gold:-r});const g=(b=window.Telegram)==null?void 0:b.WebApp;(x=g==null?void 0:g.sendData)==null||x.call(g,JSON.stringify({type:"purchase",title:n.name,price:r,qty:1}))}catch(g){}}const W=new Set(["helmet","chest","pants","boots","gloves","weapon"]),E=M.useMemo(()=>T.filter(s=>W.has(s.slot)&&s.slot!=="weapon"),[]),a=M.useMemo(()=>T.filter(s=>s.slot==="misc"),[]),h=M.useMemo(()=>T.filter(s=>s.slot==="weapon"),[]);function R(s){var y,b,x,g,z,F;const n=t.inventory[s];if(!n)return;const o=S.get(n.id),r=o?ie(o,t):10,u=t.inventory.slice();u.splice(s,1);const c={...t,gold:t.gold+r,inventory:u};te(c),d(c),se("quest",(b=(y=i.merchant)==null?void 0:y.sale)!=null?b:"Sale",{gold:r});const l=(x=window.Telegram)==null?void 0:x.WebApp;(F=l==null?void 0:l.sendData)==null||F.call(l,JSON.stringify({type:"sale",title:(z=(g=o==null?void 0:o.name)!=null?g:n.name)!=null?z:"Item",price:r,qty:1}))}return e.jsxs("div",{style:{display:"grid",gap:12,padding:16},children:[e.jsx(ce,{title:(I=(j=i.buttons)==null?void 0:j.merchant)!=null?I:"Merchant",gold:t.gold,energy:t.energy,level:t.progress.level,onBack:v}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(w,{onClick:()=>C("buy"),disabled:f==="buy",children:(_=(N=i.merchant)==null?void 0:N.buy)!=null?_:"Buy"}),e.jsx(w,{onClick:()=>C("sell"),disabled:f==="sell",children:(J=(A=i.merchant)==null?void 0:A.sell)!=null?J:"Sell"})]}),f==="buy"&&e.jsxs("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:[e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[e.jsx(w,{onClick:()=>p("resources"),disabled:m==="resources",children:(H=(K=i.merchant)==null?void 0:K.resources)!=null?H:"Resources"}),e.jsx(w,{onClick:()=>p("clothing"),disabled:m==="clothing",children:(V=(G=i.merchant)==null?void 0:G.armor)!=null?V:"Armor"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:8},children:e.jsx(w,{onClick:()=>p("weapons"),disabled:m==="weapons",children:(Q=(Y=i.merchant)==null?void 0:Y.weapons)!=null?Q:"Weapons"})}),m==="resources"&&e.jsx("div",{style:{display:"grid",gap:8,marginBottom:12},children:a.map(s=>{var u,c,l,y;const n=Math.round(s.basePrice*q(s.rarity)),o=$("buy",n,t),r=t.gold<o;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[s.image?e.jsx("img",{src:s.image,alt:s.name,style:{width:32,height:32,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:32,height:32,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[s.name," ",e.jsxs("span",{style:{color:O(s.rarity),fontSize:12,marginLeft:6},children:["Rarity: ",s.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:[(c=(u=i.merchant)==null?void 0:u.price)!=null?c:"Price",": ",o]})]})]}),e.jsx(w,{onClick:()=>k(s.id),disabled:r,children:(y=(l=i.merchant)==null?void 0:l.buy)!=null?y:"Buy"})]},s.id)})}),m==="clothing"&&e.jsx("div",{style:{display:"grid",gap:12,marginBottom:12},children:["warrior","volkhv","hunter"].map(s=>e.jsx("div",{style:{display:"grid",gap:8},children:[1,2,3,4].map(n=>{const o=E.filter(r=>r.classReq===s&&/_t\d+$/.test(r.id)&&r.id.endsWith("t".concat(n)));return o.length===0?null:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{opacity:.9,fontWeight:700},children:"Set ".concat(s," T").concat(n)}),o.map(r=>{var y,b,x,g,z,F,U,ee;const u=Math.round(r.basePrice*q(r.rarity)),c=$("buy",u,t),l=t.gold<c;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[r.image?e.jsx("img",{src:r.image,alt:r.name,style:{width:36,height:36,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:36,height:36,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[r.name," ",e.jsxs("span",{style:{color:O(r.rarity),fontSize:12,marginLeft:6},children:[(b=(y=i.merchant)==null?void 0:y.rarity)!=null?b:"Rarity",": ",r.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:[(g=(x=i.merchant)==null?void 0:x.price)!=null?g:"Price",": ",c," ",r.requiredLevel?"• ".concat((F=(z=i.merchant)==null?void 0:z.reqLevel)!=null?F:"Req Lv."," ").concat(r.requiredLevel,"+"):""]})]})]}),e.jsx(w,{onClick:()=>k(r.id),disabled:l,children:(ee=(U=i.merchant)==null?void 0:U.buy)!=null?ee:"Buy"})]},r.id)})]},"".concat(s,"_t").concat(n))})},s))}),m==="weapons"&&e.jsx("div",{style:{display:"grid",gap:12,marginBottom:12},children:["warrior","volkhv","hunter"].map(s=>e.jsx("div",{style:{display:"grid",gap:8},children:[1,2,3,4].map(n=>{const o=h.filter(r=>r.classReq===s&&/_t\d+$/.test(r.id)&&r.id.endsWith("t".concat(n)));return o.length===0?null:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{opacity:.9,fontWeight:700},children:"Weapons ".concat(s," T").concat(n)}),o.map(r=>{const u=Math.round(r.basePrice*q(r.rarity)),c=$("buy",u,t),l=t.gold<c;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[r.image?e.jsx("img",{src:r.image,alt:r.name,style:{width:36,height:36,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:36,height:36,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[r.name," ",e.jsxs("span",{style:{color:O(r.rarity),fontSize:12,marginLeft:6},children:["Rarity: ",r.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Price: ",c," ",r.requiredLevel?"• Req Lv. ".concat(r.requiredLevel,"+"):""]})]})]}),e.jsx(w,{onClick:()=>k(r.id),disabled:l,children:"Buy"})]},r.id)})]},"".concat(s,"_t").concat(n))})},s))})]}),f==="sell"&&e.jsx("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:e.jsxs("div",{style:{display:"grid",gap:8},children:[t.inventory.length===0&&e.jsx("div",{style:{opacity:.8},children:(Z=(X=i.merchant)==null?void 0:X.noItems)!=null?Z:"No items to sell."}),t.inventory.map((s,n)=>{var u,c,l,y,b,x;const o=S.get(s.id),r=o?ie(o,t):10;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:10},children:e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[s.name," ",o?e.jsxs("span",{style:{color:O(o.rarity),fontSize:12,marginLeft:6},children:[(c=(u=i.merchant)==null?void 0:u.rarity)!=null?c:"Rarity",": ",o.rarity]}):null]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:[(y=(l=i.merchant)==null?void 0:l.sellFor)!=null?y:"Sell for",": ",r]})]})}),e.jsx(w,{onClick:()=>R(n),children:(x=(b=i.merchant)==null?void 0:b.sell)!=null?x:"Sell"})]},"".concat(s.id,"_").concat(n))})]})})]})}export{fe as default};
