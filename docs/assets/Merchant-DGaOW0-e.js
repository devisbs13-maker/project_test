import{r as j,j as e,s as D,n as N}from"./index-zNkj3aJ-.js";import{H as J}from"./Header-C-FKlxx7.js";import{B as m}from"./Button-V5W3o_8C.js";import{C as q}from"./catalog-z_q2Z5IU.js";const F="mirevald:economy";function z(t){localStorage.setItem(F,JSON.stringify(t))}function K(){try{const t=localStorage.getItem(F);return t?JSON.parse(t):null}catch(t){return null}}const O=(t,g,a)=>Math.max(g,Math.min(a,t));function k(t,g,a){var n,r,i;const d=(n=a.karma)!=null?n:0,w=(r=a.luck)!=null?r:0,y=(i=a.sociality)!=null?i:0,p=O(d,-30,30)/30,b=1-p*.12,R=1+p*.08,x=O(w,0,30)/30,B=1-x*.04,v=1+x*.03,C=1+-Math.min(.08,Math.floor(y/5)*.01),I=b*B*C,$=R*v,o=t==="buy"?I:$,l=1+(Math.random()*.02-.01),s=g*o*l;return Math.max(1,Math.round(s))}function M(t){return t==="common"?1:t==="uncommon"?1.2:t==="rare"?1.6:2.2}function T(t,g){var d;const a=Math.round(((d=t.sellBase)!=null?d:t.basePrice*.45)*M(t.rarity));return k("sell",a,g)}const H="v2",A=()=>"".concat(new Date().toISOString().slice(0,10),"-").concat(H);function _(t){var S,C,I,$;const g=A(),a=()=>Math.random(),d=(C=(S=t.progress)==null?void 0:S.level)!=null?C:1,w=[{t:1,lvl:1},{t:2,lvl:20},{t:3,lvl:40},{t:4,lvl:60}],y=(I=[...w].reverse().find(o=>d>=o.lvl))!=null?I:w[0],p=q.filter(o=>o.classReq===t.classId&&/_t\d+$/.test(o.id)&&o.id.endsWith("t".concat(y.t))),b=[];for(const o of p){const l=M(o.rarity),s=Math.round(o.basePrice*l),n=k("buy",s,t);b.push({itemId:o.id,qty:1,price:n,rarity:o.rarity})}const R=q.filter(o=>!b.find(l=>l.itemId===o.id)),x=Math.min(30,Math.max(0,($=t.luck)!=null?$:0)),B=.15+x*.01,v=.04+x*.004;for(;b.length<8&&R.length;){const o=Math.floor(a()*R.length),l=R.splice(o,1)[0];if(l.rarity==="rare"&&a()>B||l.rarity==="epic"&&a()>v)continue;const s=M(l.rarity),n=Math.round(l.basePrice*s),r=k("buy",n,t);b.push({itemId:l.id,qty:1+Math.floor(a()*2),price:r,rarity:l.rarity})}return{dateKey:g,offers:b}}function G(t){return t.dateKey!==A()}function L(t){return t==="common"?"#9aa3ad":t==="uncommon"?"#3fb950":t==="rare"?"#539bf5":"#a371f7"}function Z({player:t,onBack:g,onUpdatePlayer:a}){const[d,w]=j.useState("buy"),[y,p]=j.useState("resources"),[b,R]=j.useState("all"),[x,B]=j.useState(()=>{const s=K();if(!s||G(s)){const n=_(t);return z(n),n}return s}),v=j.useMemo(()=>new Map(q.map(s=>[s.id,s])),[]);try{const s=x.offers.filter(n=>v.has(n.itemId));if(x.offers.length>0&&s.length===0){const n=_(t);z(n),B(n)}}catch(s){}function S(s){var c,P;const n=v.get(s);if(!n)return;const r=Math.round(n.basePrice*M(n.rarity)),i=k("buy",r,t);if(t.gold<i)return;const f={id:n.id,name:n.name,slot:n.slot,rarity:n.rarity,requiredLevel:n.requiredLevel,classReq:n.classReq},u={...t,gold:t.gold-i,inventory:[...t.inventory,f]};D(u),a(u);try{N("quest","Purchase",{gold:-i});const h=(c=window.Telegram)==null?void 0:c.WebApp;(P=h==null?void 0:h.sendData)==null||P.call(h,JSON.stringify({type:"purchase",title:n.name,price:i,qty:1}))}catch(h){}}const C=new Set(["helmet","chest","pants","boots","gloves","weapon"]),I=j.useMemo(()=>q.filter(s=>C.has(s.slot)&&s.slot!=="weapon"),[]),$=j.useMemo(()=>q.filter(s=>s.slot==="misc"),[]),o=j.useMemo(()=>q.filter(s=>s.slot==="weapon"),[]);function l(s){var P,h,W,E;const n=t.inventory[s];if(!n)return;const r=v.get(n.id),i=r?T(r,t):10,f=t.inventory.slice();f.splice(s,1);const u={...t,gold:t.gold+i,inventory:f};D(u),a(u),N("quest","Sale",{gold:i});const c=(P=window.Telegram)==null?void 0:P.WebApp;(E=c==null?void 0:c.sendData)==null||E.call(c,JSON.stringify({type:"sale",title:(W=(h=r==null?void 0:r.name)!=null?h:n.name)!=null?W:"Item",price:i,qty:1}))}return e.jsxs("div",{style:{display:"grid",gap:12,padding:16},children:[e.jsx(J,{title:"Merchant",gold:t.gold,energy:t.energy,level:t.progress.level,onBack:g}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(m,{onClick:()=>w("buy"),disabled:d==="buy",children:"Buy"}),e.jsx(m,{onClick:()=>w("sell"),disabled:d==="sell",children:"Sell"})]}),d==="buy"&&e.jsxs("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:[e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[e.jsx(m,{onClick:()=>p("resources"),disabled:y==="resources",children:"Resources"}),e.jsx(m,{onClick:()=>p("clothing"),disabled:y==="clothing",children:"Armor"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:8},children:e.jsx(m,{onClick:()=>p("weapons"),disabled:y==="weapons",children:"Weapons"})}),y==="resources"&&e.jsx("div",{style:{display:"grid",gap:8,marginBottom:12},children:$.map(s=>{const n=Math.round(s.basePrice*M(s.rarity)),r=k("buy",n,t),i=t.gold<r;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[s.image?e.jsx("img",{src:s.image,alt:s.name,style:{width:32,height:32,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:32,height:32,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[s.name," ",e.jsxs("span",{style:{color:L(s.rarity),fontSize:12,marginLeft:6},children:["Rarity: ",s.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Price: ",r]})]})]}),e.jsx(m,{onClick:()=>S(s.id),disabled:i,children:"Buy"})]},s.id)})}),y==="clothing"&&e.jsx("div",{style:{display:"grid",gap:12,marginBottom:12},children:["warrior","volkhv","hunter"].map(s=>e.jsx("div",{style:{display:"grid",gap:8},children:[1,2,3,4].map(n=>{const r=I.filter(i=>i.classReq===s&&/_t\d+$/.test(i.id)&&i.id.endsWith("t".concat(n)));return r.length===0?null:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{opacity:.9,fontWeight:700},children:"Set ".concat(s," T").concat(n)}),r.map(i=>{const f=Math.round(i.basePrice*M(i.rarity)),u=k("buy",f,t),c=t.gold<u;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[i.image?e.jsx("img",{src:i.image,alt:i.name,style:{width:36,height:36,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:36,height:36,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[i.name," ",e.jsxs("span",{style:{color:L(i.rarity),fontSize:12,marginLeft:6},children:["Rarity: ",i.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Price: ",u," ",i.requiredLevel?"• Req Lv. ".concat(i.requiredLevel,"+"):""]})]})]}),e.jsx(m,{onClick:()=>S(i.id),disabled:c,children:"Buy"})]},i.id)})]},"".concat(s,"_t").concat(n))})},s))}),y==="weapons"&&e.jsx("div",{style:{display:"grid",gap:12,marginBottom:12},children:["warrior","volkhv","hunter"].map(s=>e.jsx("div",{style:{display:"grid",gap:8},children:[1,2,3,4].map(n=>{const r=o.filter(i=>i.classReq===s&&/_t\d+$/.test(i.id)&&i.id.endsWith("t".concat(n)));return r.length===0?null:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{opacity:.9,fontWeight:700},children:"Weapons ".concat(s," T").concat(n)}),r.map(i=>{const f=Math.round(i.basePrice*M(i.rarity)),u=k("buy",f,t),c=t.gold<u;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[i.image?e.jsx("img",{src:i.image,alt:i.name,style:{width:36,height:36,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:36,height:36,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[i.name," ",e.jsxs("span",{style:{color:L(i.rarity),fontSize:12,marginLeft:6},children:["Rarity: ",i.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Price: ",u," ",i.requiredLevel?"• Req Lv. ".concat(i.requiredLevel,"+"):""]})]})]}),e.jsx(m,{onClick:()=>S(i.id),disabled:c,children:"Buy"})]},i.id)})]},"".concat(s,"_t").concat(n))})},s))})]}),d==="sell"&&e.jsx("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:e.jsxs("div",{style:{display:"grid",gap:8},children:[t.inventory.length===0&&e.jsx("div",{style:{opacity:.8},children:"No items to sell."}),t.inventory.map((s,n)=>{const r=v.get(s.id),i=r?T(r,t):10;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:10},children:e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[s.name," ",r?e.jsxs("span",{style:{color:L(r.rarity),fontSize:12,marginLeft:6},children:["Rarity: ",r.rarity]}):null]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Sell for: ",i]})]})}),e.jsx(m,{onClick:()=>l(n),children:"Sell"})]},"".concat(s.id,"_").concat(n))})]})})]})}export{Z as default};
