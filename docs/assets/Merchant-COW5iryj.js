import{r as j,j as e,s as D,n as z}from"./index-BXj9KiiF.js";import{H as J}from"./Header-Dl4dmuQR.js";import{B as p}from"./Button-CV-dwmT3.js";import{C as q}from"./catalog-BEuPirhP.js";const T="mirevald:economy";function N(t){localStorage.setItem(T,JSON.stringify(t))}function K(){try{const t=localStorage.getItem(T);return t?JSON.parse(t):null}catch(t){return null}}const O=(t,y,a)=>Math.max(y,Math.min(a,t));function M(t,y,a){var i,r,n;const u=(i=a.karma)!=null?i:0,w=(r=a.luck)!=null?r:0,h=(n=a.sociality)!=null?n:0,b=O(u,-30,30)/30,x=1-b*.12,C=1+b*.08,v=O(w,0,30)/30,B=1-v*.04,f=1+v*.03,R=1+-Math.min(.08,Math.floor(h/5)*.01),I=x*B*R,$=C*f,o=t==="buy"?I:$,l=1+(Math.random()*.02-.01),s=y*o*l;return Math.max(1,Math.round(s))}function S(t){return t==="common"?1:t==="uncommon"?1.2:t==="rare"?1.6:2.2}function F(t,y){var u;const a=Math.round(((u=t.sellBase)!=null?u:t.basePrice*.45)*S(t.rarity));return M("sell",a,y)}const H="v2",A=()=>"".concat(new Date().toISOString().slice(0,10),"-").concat(H);function _(t){var k,R,I,$;const y=A(),a=()=>Math.random(),u=(R=(k=t.progress)==null?void 0:k.level)!=null?R:1,w=[{t:1,lvl:1},{t:2,lvl:20},{t:3,lvl:40},{t:4,lvl:60}],h=(I=[...w].reverse().find(o=>u>=o.lvl))!=null?I:w[0],b=q.filter(o=>o.classReq===t.classId&&/_t\d+$/.test(o.id)&&o.id.endsWith("t".concat(h.t))),x=[];for(const o of b){const l=S(o.rarity),s=Math.round(o.basePrice*l),i=M("buy",s,t);x.push({itemId:o.id,qty:1,price:i,rarity:o.rarity})}const C=q.filter(o=>!x.find(l=>l.itemId===o.id)),v=Math.min(30,Math.max(0,($=t.luck)!=null?$:0)),B=.15+v*.01,f=.04+v*.004;for(;x.length<8&&C.length;){const o=Math.floor(a()*C.length),l=C.splice(o,1)[0];if(l.rarity==="rare"&&a()>B||l.rarity==="epic"&&a()>f)continue;const s=S(l.rarity),i=Math.round(l.basePrice*s),r=M("buy",i,t);x.push({itemId:l.id,qty:1+Math.floor(a()*2),price:r,rarity:l.rarity})}return{dateKey:y,offers:x}}function G(t){return t.dateKey!==A()}function L(t){return t==="common"?"#9aa3ad":t==="uncommon"?"#3fb950":t==="rare"?"#539bf5":"#a371f7"}function Z({player:t,onBack:y,onUpdatePlayer:a}){const[u,w]=j.useState("buy"),[h,b]=j.useState("resources"),[x,C]=j.useState("all"),[v,B]=j.useState(()=>{const s=K();if(!s||G(s)){const i=_(t);return N(i),i}return s}),f=j.useMemo(()=>new Map(q.map(s=>[s.id,s])),[]);try{const s=v.offers.filter(i=>f.has(i.itemId));if(v.offers.length>0&&s.length===0){const i=_(t);N(i),B(i)}}catch(s){}function k(s){var d,W;const i=f.get(s);if(!i)return;const r=Math.round(i.basePrice*S(i.rarity)),n=M("buy",r,t);if(t.gold<n)return;const g={id:i.id,name:i.name,slot:i.slot,rarity:i.rarity,requiredLevel:i.requiredLevel,classReq:i.classReq},c={...t,gold:t.gold-n,inventory:[...t.inventory,g]};D(c),a(c);try{z("quest","РџРѕРєСѓРїРєР°",{gold:-n});const m=(d=window.Telegram)==null?void 0:d.WebApp;(W=m==null?void 0:m.sendData)==null||W.call(m,JSON.stringify({type:"purchase",title:i.name,price:n,qty:1}))}catch(m){}}const R=new Set(["helmet","chest","pants","boots","gloves","weapon"]),I=j.useMemo(()=>q.filter(s=>R.has(s.slot)&&s.slot!=="weapon"),[]),$=j.useMemo(()=>q.filter(s=>s.slot==="misc"),[]),o=j.useMemo(()=>q.filter(s=>s.slot==="weapon"),[]);function l(s){var W,m,P,E;const i=t.inventory[s];if(!i)return;const r=f.get(i.id),n=r?F(r,t):10,g=t.inventory.slice();g.splice(s,1);const c={...t,gold:t.gold+n,inventory:g};D(c),a(c),z("quest","РџСЂРѕРґР°Р¶Р°",{gold:n});const d=(W=window.Telegram)==null?void 0:W.WebApp;(E=d==null?void 0:d.sendData)==null||E.call(d,JSON.stringify({type:"sale",title:(P=(m=r==null?void 0:r.name)!=null?m:i.name)!=null?P:"РўРѕРІР°СЂ",price:n,qty:1}))}return e.jsxs("div",{style:{display:"grid",gap:12,padding:16},children:[e.jsx(J,{title:"РўРѕСЂРіРѕРІРµС†",gold:t.gold,energy:t.energy,level:t.progress.level,onBack:y}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(p,{onClick:()=>w("buy"),disabled:u==="buy",children:"РљСѓРїРёС‚СЊ"}),e.jsx(p,{onClick:()=>w("sell"),disabled:u==="sell",children:"РџСЂРѕРґР°С‚СЊ"})]}),u==="buy"&&e.jsxs("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:[e.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[e.jsx(p,{onClick:()=>b("resources"),disabled:h==="resources",children:"Р РµСЃСѓСЂСЃС‹"}),e.jsx(p,{onClick:()=>b("clothing"),disabled:h==="clothing",children:"РћРґРµР¶РґР°"})]}),e.jsx("div",{style:{display:"flex",gap:8,marginBottom:8},children:e.jsx(p,{onClick:()=>b("weapons"),disabled:h==="weapons",children:"Оружие"})}),h==="resources"&&e.jsx("div",{style:{display:"grid",gap:8,marginBottom:12},children:$.map(s=>{const i=Math.round(s.basePrice*S(s.rarity)),r=M("buy",i,t),n=t.gold<r;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[s.image?e.jsx("img",{src:s.image,alt:s.name,style:{width:32,height:32,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:32,height:32,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[s.name," ",e.jsxs("span",{style:{color:L(s.rarity),fontSize:12,marginLeft:6},children:["СЂРµРґРєРѕСЃС‚СЊ: ",s.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Р¦РµРЅР°: в‚Ѕ ",r]})]})]}),e.jsx(p,{onClick:()=>k(s.id),disabled:n,children:"РљСѓРїРёС‚СЊ"})]},s.id)})}),h==="clothing"&&e.jsx("div",{style:{display:"grid",gap:12,marginBottom:12},children:["warrior","volkhv","hunter"].map(s=>e.jsx("div",{style:{display:"grid",gap:8},children:[1,2,3,4].map(i=>{const r=I.filter(n=>n.classReq===s&&/_t\d+$/.test(n.id)&&n.id.endsWith("t".concat(i)));return r.length===0?null:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{opacity:.9,fontWeight:700},children:"РЎРµС‚ ".concat(s," t").concat(i)}),r.map(n=>{const g=Math.round(n.basePrice*S(n.rarity)),c=M("buy",g,t),d=t.gold<c;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[n.image?e.jsx("img",{src:n.image,alt:n.name,style:{width:36,height:36,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:36,height:36,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[n.name," ",e.jsxs("span",{style:{color:L(n.rarity),fontSize:12,marginLeft:6},children:["СЂРµРґРєРѕСЃС‚СЊ: ",n.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Р¦РµРЅР°: в‚Ѕ ",c," ",n.requiredLevel?"вЂў СѓСЂ. ".concat(n.requiredLevel,"+"):""]})]})]}),e.jsx(p,{onClick:()=>k(n.id),disabled:d,children:"РљСѓРїРёС‚СЊ"})]},n.id)})]},"".concat(s,"_t").concat(i))})},s))}),h==="weapons"&&e.jsx("div",{style:{display:"grid",gap:12,marginBottom:12},children:["warrior","volkhv","hunter"].map(s=>e.jsx("div",{style:{display:"grid",gap:8},children:[1,2,3,4].map(i=>{const r=o.filter(n=>n.classReq===s&&/_t\\d+$/.test(n.id)&&n.id.endsWith("t".concat(i)));return r.length===0?null:e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{opacity:.9,fontWeight:700},children:"Weapons ".concat(s," t").concat(i)}),r.map(n=>{const g=Math.round(n.basePrice*S(n.rarity)),c=M("buy",g,t),d=t.gold<c;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10},children:[n.image?e.jsx("img",{src:n.image,alt:n.name,style:{width:36,height:36,objectFit:"cover",borderRadius:6}}):e.jsx("div",{style:{width:36,height:36,borderRadius:6,background:"rgba(255,255,255,0.07)"}}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[n.name," ",e.jsxs("span",{style:{color:L(n.rarity),fontSize:12,marginLeft:6},children:["Раритет: ",n.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Цена: ₽ ",c," ",n.requiredLevel?"и ур. ".concat(n.requiredLevel,"+"):""]})]})]}),e.jsx(p,{onClick:()=>k(n.id),disabled:d,children:"Купить"})]},n.id)})]},"".concat(s,"_t").concat(i))})},s))})]}),u==="sell"&&e.jsx("section",{style:{padding:12,borderRadius:16,background:"var(--panel-bg)",border:"var(--panel-border)"},children:e.jsxs("div",{style:{display:"grid",gap:8},children:[t.inventory.length===0&&e.jsx("div",{style:{opacity:.8},children:"РЈ РІР°СЃ РЅРµС‚ РїСЂРµРґРјРµС‚РѕРІ РґР»СЏ РїСЂРѕРґР°Р¶Рё."}),t.inventory.map((s,i)=>{var g,c;const r=f.get(s.id),n=r?F(r,t):10;return e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",borderRadius:12,background:"var(--panel-bg)",border:"1px solid rgba(255,255,255,0.08)"},children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:700},children:[(c=(g=s.name)!=null?g:r==null?void 0:r.name)!=null?c:s.id," ",r&&e.jsxs("span",{style:{color:L(r.rarity),fontSize:12,marginLeft:6},children:["Р РµРґРєРѕСЃС‚СЊ: ",r.rarity]})]}),e.jsxs("div",{style:{opacity:.85,fontSize:12},children:["Р¦РµРЅР° РїСЂРѕРґР°Р¶Рё: рџЄ™ ",n]})]}),e.jsx(p,{onClick:()=>l(i),children:"РџСЂРѕРґР°С‚СЊ"})]},i)})]})})]})}export{Z as default};
