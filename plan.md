# Telegram Bot (JS/TS) — План проекта

Этот документ — основной ориентир: цели, архитектура, решения и пошаговый план. Поддерживаем его в актуальном состоянии, отмечаем выполненные шаги и фиксируем решения.

## 1) Контекст и цели
- Простота, чистота и аккуратность: без юнит‑тестов, но с правильной структурой.
- Язык: TypeScript поверх Node.js (удобнее типы и DX). Используем JS там, где нужно.
- Минимально жизнеспособный функционал (MVP), затем эволюционное развитие.
- Разработка: локально на long polling; прод: по желанию webhook.

## 2) Технические решения и договорённости
- Node.js: LTS (например, 20.x).
- Пакетный менеджер: npm (по умолчанию). Можно сменить на pnpm/yarn по желанию.
- Фреймворк Telegram:
  - Рекомендация: grammY (современный, типобезопасный, богатая экосистема).
  - Альтернатива: Telegraf (популярный, зрелый). Решение зафиксируем перед реализацией.
- Конфигурация: `.env` + валидация (zod), один модуль `config/`.
- Логирование: `pino` (структурированные логи, уровни), fallback — `console` в dev.
- Хранение данных: изначально in‑memory/файловое (JSON), абстрагировано через интерфейс `Repository`. Возможность заменить на SQLite/Prisma позже без переписывания логики.
- Архитектурный стиль: модульная, слои «бот ↔ роутинг команд ↔ middlewares ↔ сервисы ↔ репозитории».
- Код‑стайл: ESLint + Prettier (минимальная конфигурация), EditorConfig.
- Ошибки: централизованный обработчик (middleware), разруливание «мягких»/«фатальных». Грациозное завершение.
- i18n: опционально, начнём с RU/EN в будущем при необходимости.

## 3) Архитектура (обзор)
- Вход: `src/index.ts` — чтение конфига, инициализация бота, запуск long polling или webhook.
- `src/bot/` — инициализация инстанса бота и middleware‑цепочки.
- `src/commands/` — декларативные модули команд (`/start`, `/help`, ...), роутинг по контексту.
- `src/middlewares/` — логирование, обработка ошибок, ограничения (rate limit), защита от старых апдейтов.
- `src/services/` — прикладная логика (работа с доменом), независимая от Telegram API.
- `src/repositories/` — доступ к данным (in‑memory/файлы/БД), единый интерфейс.
- `src/config/` — сбор и валидация настроек окружения.
- `src/types/` — общие типы, контракты, DTO.
- `src/utils/` — утилиты (форматирование, парсинг, helpers).
- (опц.) `src/server/` — HTTP‑обёртка для webhook (Express/Fastify) + healthcheck.

Поток обработки:
Telegram Update → Middlewares → Router команд → Сервисы → Репозитории → Ответ пользователю

## 4) Структура каталогов (черновик)
```
.
├─ src/
│  ├─ index.ts                 # Точка входа
│  ├─ bot/
│  │  └─ bot.ts                # Инициализация бота и middleware
│  ├─ commands/
│  │  ├─ index.ts              # Регистрация/роутинг команд
│  │  ├─ start.ts              # /start
│  │  ├─ help.ts               # /help
│  │  └─ ping.ts               # /ping (проверка живости)
│  ├─ middlewares/
│  │  ├─ logging.ts
│  │  ├─ error.ts
│  │  └─ rateLimit.ts          # простая защита от спама
│  ├─ services/
│  │  └─ userService.ts        # пример сервиса
│  ├─ repositories/
│  │  ├─ index.ts              # контракты/фабрики
│  │  ├─ memoryUserRepo.ts     # in-memory реализация
│  │  └─ fileUserRepo.ts       # файловая реализация (опционально)
│  ├─ config/
│  │  ├─ env.ts                # загрузка .env
│  │  └─ schema.ts             # zod‑валидация
│  ├─ types/
│  │  └─ index.ts
│  └─ utils/
│     └─ index.ts
├─ .env                        # локальные секреты (не коммитим)
├─ .env.example                # шаблон переменных
├─ package.json
├─ tsconfig.json
├─ .eslintrc.cjs               # минимальная конфигурация
├─ .prettierrc                 # форматирование
├─ .editorconfig
└─ README.md
```

## 5) Окружения и секреты
Переменные окружения (через `.env`):
- `BOT_TOKEN` — токен бота (обязателен).
- `NODE_ENV` — `development` | `production`.
- `PORT` — порт для webhook/healthcheck (по умолчанию 3000).
- `WEBHOOK_URL` — публичный URL для webhook (если используем вебхуки).
- `ADMIN_ID` — опционально, ID админа для служебных команд/уведомлений.

Файл `.env.example` содержит ключи без значений и комментарии.

## 6) Пошаговый план (чеклист)
Статусы: [ ] не начато, [~] в процессе, [x] готово.

Фаза 0 — Планирование
- [x] Создать и согласовать `plan.md` (этот документ).
- [ ] Зафиксировать решения: фреймворк (grammY/Telegraf), пакетный менеджер (npm/pnpm), способ запуска в проде (polling/webhook).

Фаза 1 — Бутстрап проекта
- [ ] Инициализировать `package.json`, `tsconfig.json`, минимальные скрипты.
- [ ] Добавить ESLint + Prettier + EditorConfig (базовый набор правил).
- [ ] Настроить `nodemon`/`ts-node-dev` для dev.

Фаза 2 — Конфигурация
- [ ] Ввести `src/config/` с `zod`‑валидацией переменных окружения.
- [ ] Подготовить `.env.example` и описать требования в `README.md`.

Фаза 3 — Инициализация бота
- [ ] Подключить выбранный фреймворк (предпочтительно grammY).
- [ ] Реализовать `src/bot/bot.ts` + базовые middlewares: логирование, ошибки, игнор старых апдейтов.
- [ ] Запуск в dev через long polling.

Фаза 4 — Команды (MVP)
- [ ] `/start` — приветствие и краткая справка.
- [ ] `/help` — перечисление команд и возможностей.
- [ ] `/ping` — ответ «pong» с временем отклика.
- [ ] Echo‑режим по желанию (ответ тем же текстом).

Фаза 5 — Сервисы и данные
- [ ] Ввести интерфейс `UserRepository` + in‑memory реализацию.
- [ ] `userService` с базовыми операциями (регистрация/обновление метаданных).
- [ ] (опц.) файловое хранилище JSON или SQLite (для долговременности).

Фаза 6 — Эксплуатация
- [ ] Healthcheck endpoint (если будет HTTP‑сервер).
- [ ] Грациозное завершение (SIGINT/SIGTERM), корректная остановка polling/webhook.
- [ ] Структурированные логи через `pino`, уровни по `NODE_ENV`.

Фаза 7 — Webhook (опционально)
- [ ] HTTP‑сервер (Express/Fastify), защищённый endpoint для Telegram.
- [ ] Настройка `WEBHOOK_URL` и команды установки webhook.
- [ ] Документация по деплою (Railway/Render/Fly.io/Docker).

Фаза 8 — Документация
- [ ] Описать запуск локально, переменные, скрипты, типовые команды.
- [ ] Добавить раздел FAQ/отладка и типичные проблемы.

Фаза 9 — Дальнейшее развитие (идеи)
- [ ] i18n (RU/EN), кнопки/кейборды, сцены/мастера (wizard).
- [ ] Роли/права (admin‑only), простая аналитика событий.
- [ ] Интеграции (внешние API), кеширование.

## 7) Скрипты (план)
- `npm run dev` — запуск в dev (ts-node-dev/nodemon + ts-node).
- `npm run build` — сборка в `dist` (tsc).
- `npm run start` — запуск собранного JS из `dist`.
- `npm run lint` / `npm run lint:fix` — линтинг и автоисправления.
- (опц.) `npm run webhook:set` / `webhook:delete` — команды для управления webhook.

## 8) Критерии качества
- Простая, предсказуемая структура, чёткие границы модулей.
- Отсутствие «жёстких» связей: команды не знают про детали хранилищ, только про сервисы.
- Конфигурация валидируется на старте, ошибки — явные и полезные.
- Логи структурированы; dev‑режим — дружелюбен к разработчику.
- README и этот план позволяют быстро войти в проект.

## 9) Риски и открытые вопросы
- Выбор фреймворка (grammY vs Telegraf) — предпочтение grammY для TS.
- Где хостим прод (если нужен): Railway/Render/Fly.io/VPS? Влияет на webhook.
- Нужна ли долговременная персистентность (SQLite/Prisma) прямо сейчас?
- Возможные ограничения на нагрузку/скорость (нужен ли rate limit сильнее?).

## 10) Журнал изменений плана
- v0: создан `plan.md`, описана архитектура и чеклист.

---

Как использовать этот файл:
- Всегда обновлять чеклист и решения по мере выполнения.
- Ссылаться на разделы при обсуждении и PR’ах.
- Если решения меняются — фиксировать в «Риски и открытые вопросы» и в «Журнале изменений».
